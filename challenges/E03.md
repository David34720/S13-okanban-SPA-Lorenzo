# O'kanban - SPA E03 - CRUD & Drag & Drop

[Rappel : lien pour crÃ©er des issues](https://github.com/O-clock-Quindim/Soutien-ateliers/issues)

## Ã‰tape 1 - On relance les serveurs

On rappelle Ã  toute fin utile qu'il faut lancer le frontend ET le backend indÃ©pendamment pour que les deux puissent communiquer ğŸ—£ï¸.

## Ã‰tape 2 - Modifier une liste

### 2.1. CrÃ©er une fenÃªtre de dialogue d'Ã©dition de liste

Dans le HTML, s'inspirer de la fenÃªtre de dialogue d'ajout de liste existante et crÃ©er une nouvelle fenÃªtre de dialogue pour l'Ã©dition du titre d'une liste.

> **ASTUCE** l'afficher avec la classe `is-active` (codÃ©e en dur) pour la tester, puis retirer cette classe que l'on ajoutera dynamiquement suite Ã  une interaction de l'utilisateur.

### 2.2. CrÃ©er le bouton d'Ã©dition

Dans le HTML, modifier le template d'une liste pour ajouter une icÃ´ne Â« crayon Â» ğŸ–ï¸ Ã  l'aide de la librairie `Font Awesome` dÃ©jÃ  en place (V6).

On peut s'inspirer du code existant pour le bouton Â« plus Â» â•.

### 2.3. Ouvrir la fenÃªtre de dialogue

Lors d'un clic sur ce bouton, depuis n'importe quelle liste, on souhaite ouvrir la fenÃªtre de dialogue d'Ã©dition. Pour cela, il faut poser un _listener_ sur ce bouton.

**ProblÃ¨me** : Ã  l'ouverture de la page par l'utilisateur, les listes ne sont pas encore prÃ©sentes dans le DOM, puisque le frontend doit les `fetch` au prÃ©alable.

**Solution** : on doit poser le _listener_ directement sur le clone avant son insertion dans le DOM, c'est-Ã -dire dans la fonction `addListToListsContainer`.

<details><summary>Un peu d'aide ?</summary>

```js
function addListToListsContainer(listData) {
  // ...

  const editListButton = listClone.querySelector(/* SÃ‰LECTEUR pour le bouton ğŸ–ï¸ situÃ© dans le clone */);
  editListButton.addEventListener("click", () => {
    // Ouvrir la fenÃªtre de dialogue d'Ã©dition de liste
  });
}
```

</details>

**ProblÃ¨me** : une fois la fenÃªtre de dialogue ouverte, impossible de savoir via quelle liste celle-ci a Ã©tÃ© ouverte !

**Solution** : on pourrait ajouter dans les [dataset](https://developer.mozilla.org/fr/docs/Learn/HTML/Howto/Use_data_attributes) de la fenÃªtre de dialogue d'Ã©dition, l'ID de la liste sur laquelle l'utilisateur vient de cliquer.

<details><summary>Un peu d'aide ?</summary>

```js
function addListToListsContainer(listData) {
  // ...

  const editListButton = listClone.querySelector(/* SÃ‰LECTEUR pour le bouton ğŸ–ï¸ situÃ© dans le clone */);
  editListButton.addEventListener("click", () => {
    // Ouvrir la fenÃªtre de dialogue d'Ã©dition de liste

    const editListModal = document.querySelector(/* SÃ‰LECTEUR pour la fenÃªtre de dialogue d'Ã©dition */);
    editListModal.dataset.listId = listData.id;
  });
}
```

> **Note :** vous pouvez utiliser l'inspecteur (onglet `Inspecteur` ou `Element`) pour constater le rÃ©sultat :
> lorsque vous ouvrez la fenÃªtre de dialogue, celle-ci prÃ©sente dans son HTML l'attribut `data-list-id="X"` oÃ¹ `X` est l'ID de la liste choisie.

</details>

### 2.4. Soumission du formulaire

De maniÃ¨re similaire au formulaire d'ajout d'une liste :

- Ã©couter la soumission du formulaire de modification d'une liste ;
- rÃ©cupÃ©rer les donnÃ©es du formulaire ;
- faire une requÃªte `PATCH` vers la route `/lists/:id` ;
  > l'ID de la liste Ã  modifier se trouve dans les `dataset` de la fenÃªtre de dialogue, comme vu Ã  l'Ã©tape prÃ©cÃ©dente !
- rÃ©cupÃ©rer le rÃ©sultat de la requÃªte ;
- mettre Ã  jour la liste sur la page, avec son nouveau titre ;
- fermer la fenÃªtre de dialogue ;
- re-initialiser le formulaire.

<details><summary>Un peu d'aide ?</summary>

```js
// SÃ©lectionner le formulaire d'Ã©dition de liste
//
// Ã‰couter l'Ã©vÃ¨nement `submit` sur ce formulaire, auquel cas :
// - empÃªcher le comportement par dÃ©faut du formulaire
// - rÃ©cupÃ©rer les donnÃ©es du formulaire (le nouveau titre)
// - rÃ©cupÃ©rer l'ID de la liste Ã  modifier dans les dataset de la fenÃªtre de dialogue
// - PATCH `/lists/:listId` avec comme body { "title": "..." }
// - rÃ©cupÃ©rer le rÃ©sultat de la requÃªte PATCH, et en cas de succÃ¨s
// - sÃ©lectionner la liste du DOM correspondant au bon ID
// - modifier le contenu de l'Ã©lÃ©ment avec le slot `list-title` avec le nouveau titre choisi
// - fermer la fenÃªtre de dialogue
// - reset le formulaire
//
// Festoyer !
```

</details>

---

âš ï¸ **Les deux parties suivantes sont indÃ©pendantes.** âš ï¸

---

## Ã‰tape 3 (BONUS) - Suppression d'une liste

Bon bah, rebelote, hein ğŸ¤ª !

Cette fois-ci, un peu plus dÃ©brouillard :

- ajouter un bouton de suppression sur les listes ;
- ouvrir une fenÃªtre de dialogue de Â« confirmation avant suppression Â» ;
    > **BONUS** si la liste possÃ¨de des cartes :
    > - prÃ©venir que la suppression supprimera Ã©galement toutes les cartes Ã  l'intÃ©rieur ;
    > - OU empÃªcher explicitement l'utilisateur de supprimer une liste qui possÃ¨de des cartes.

- suite Ã  la confirmation de la suppression, faire une requÃªte `DELETE` vers l'API pour supprimer la liste ;
- retirer la liste de la page ;
- fermer la fenÃªtre de dialogue.

## Ã‰tape 4 (BONUS) - Drag & Drop

On souhaiterait pouvoir modifier la **position** des listes sur le Kanban, en glissant-dÃ©posant une liste vers un nouvel emplacement.

**ProblÃ¨me :** _on va quand mÃªme pas le faire Ã  la main ğŸ™€ ?_

**Solution :** _et bah non !_ Il existe des solutions clÃ©-en-main pour la partie frontend.

## 4.1. Installation

Jeter un Å“il Ã  la [documentation](https://github.com/SortableJS/Sortable) de `SortableJS`,
aux [dÃ©monstrations](http://sortablejs.github.io/Sortable/),
et l'installer dans le code en utilisant le script fourni via un [CDN](https://github.com/SortableJS/Sortable?tab=readme-ov-file#cdn).

> **NOTE** ce script externe doit Ãªtre chargÃ© AVANT nos scripts, sinon il ne sera pas possible d'utiliser la variable globale `Sortable`.

## 4.2. Mise en place (frontend)

Objectif nÂ°1 : rÃ©ussir Ã  logger en `console` l'ID de la liste qui vient d'Ãªtre dÃ©placÃ©.

<details><summary>Un peu d'aide ?</summary>

```js
Sortable.create(ELEMENT_DU_DOM_CONTENANT_LISTES, {
  onEnd(event) {
    // Callback qui se dÃ©clenche lorsque l'utilisateur dÃ©place une liste
    console.log(event);
  }
});
```

</details>

## 4.3. Mise Ã  jour (backend)

Objectif nÂ°2 : rÃ©ussir Ã  sauvegarder la position actuelle de toutes les listes.

Pour **chaque** liste sur la page, rÃ©cupÃ©rer sa position et exÃ©cuter une requÃªte `PATCH /lists/:listId` (avec le bon body) afin de sauvegarder sa nouvelle position.

> **NOTE** cette approche n'est absolument pas performante, car on lance **une requÃªte HTTP par liste**,
> ce qui peut faire beaucoup selon le nombre de listes prÃ©sentes sur la page !
> IdÃ©alement, on aimerait uniquement mettre Ã  jour la liste qui vient d'Ãªtre dÃ©placÃ©. Nous discuterons en cours d'autres implÃ©mentations et modÃ©lisations possibles.

<details><summary>Un peu d'aide</summary>

```js
// Dans le callback 'onEnd'

// SÃ©lectionner toutes les listes sur la page
// Pour chaque liste :
// - rÃ©cupÃ©rer son ID
// - rÃ©cupÃ©rer sa position
// - faire l'appel PATCH /lists/:listId avec BODY { position: X }

```

</details>
